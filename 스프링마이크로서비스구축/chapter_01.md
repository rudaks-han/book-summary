# 01 마이크로서비스 소개



### 기술 요구사항

C4 모델 규약(https://c4model.com)



### 저자의 마이크로서비스 경험

* 2009년에 여러 개로 분리된 기능을 바탕으로 하는 플랫폼 개발
* 각 컴포넌트는 자체 데이터 저장소가 있었고, 다른 컴포넌트와는 명확한 API로 통신했다.
* 자바와 스프링 프레임워크로 개발된 각 컴포넌트는 WAR 파일로 패키징해서 아파치 톰캣과 같은 웹 컨테이너에 배포된다.



#### 독립 소프트웨어 컴포넌트의 장점

* 고객은 플랫폼의 일부분만 자체 시스템 환경에 배포할 수 있으며, 명확한 API를 사용해 기존 시스템과 통합할 수 있다.
* 어떤 고객은 플랫폼 기능의 일부를 고객의 시스템 환경에 있는 기존 구현으로 대체하는 것을 선택할 수 있다.
* 플랫폼의 각 컴포넌트는 개별적으로 배포, 업그레이드 할 수 있다.



#### 독립 소프트웨어 컴포넌트의 문제

* 컴포넌트의 새 인스턴스를 추가하려면 수동으로 로드 밸런서를 구성하고, 새 노드를 수동으로 설정해야 한다.
* 통신하는 다른 시스템에서 오류가 발생했을 때 플랫폼으로 전이된다는 근본적인 문제가 있다.
    다른 시스템이 제 시간에 응답하지 않으면 OS 스레드 같은 주요 자원이 부족하게 된다.
    플랫폼 내부 통신은 대부분 동기식이기 때문에 연속적인 오류를 유발한다.



#### 마이크로서비스 입문

일체형 애플리케이션을 유지보수 하고 개선하는 건 점점 더 어려워진다.

수직 스케일링의 한계 --> 작은 컴포넌트로 나누는 방식으로 전환

몇 가지 오픈 소스 도구와 프레임워크

* 넷플릭스 OSS를 래핑해 출시한 스프링 클라우드
* 도커
* 컨테이너 오케이스트레이터: 아파치 메소스, 도커 스웜, 아마존 ECS, 하시코프 노마드, 쿠버네티스
* 서비스 메시



### 마이크로서비스 정의

* 아무것도 공유하지 않는 아키텍처를 유지해야 한다.
* 명확한 인터페이스를 통해서만 통신해야 한다.
* 개별적인 런타임 프로세스로 배포해야 한다.
* 마이크로 인스턴스는 상태가 없다.



### 마이크로서비스의 문제

* 동기식 통신을 사용하는 다수의 컴포넌트는 연쇄 장애를 일으킬 수 있다.
* 많은 컴포넌트가 처리에 관여하는 요청은 추적하기 어렵다. 로컬에 로그 이벤트를 저장하는 경우는 분석하기 어렵다.
* 컴포넌트 수준의 하드웨어 자원 사용량 분석도 어렵다.
* 다수의 소형 컴포넌트를 수동으로 구성하고 관리하는 건 비용이 많이 들고 오류가 발생하기 쉽다.



### 마이크로서비스 디자인 패턴

* 서비스 검색(service discovery)
* 에지 서버(edge server)
* 리액티브 마이크로서비스(reactive microservice)
* 구성 중앙화(central configuration)
* 로그 분석 중앙화
* 분산 추적(distributed tracing)
* 서킷 브레이커(circuit breaker)
* 제어 루프(control loop)
* 모니터링 및 경고 중앙화



#### 서비스 검색

##### 문제점

클라이언트가 마이크로 서비스와 그 인스턴스를 찾을 수 있어야 한다.

##### 해결책

현재 사용 가능한 마이크로서비스와 그 인스턴스를 추적하는 새 컴포넌트를 시스템 환경에 추가한다.

##### 해결책의 필요 조건

* 인스턴스를 자동으로 등록 및 해지한다.
* 사용 가능한 마이크로서비스 인스턴스 중 하나로 라우팅된다.
* 상태가 비정상인 인스턴스를 감지할 수 있어야 한다.

두 가지 전략을 사용해 구현

* 클리이언트 측 라우팅: 클라이언트는 서비스 검색 서비스와의 통신을 지원하는 라이브러리를 사용해 요청을 보낼 만한 인스턴스를 찾느다.
* 서버 측 라우팅: 리버스 프록시는 클라이언트를 대신해 적절한 마이크로서비스 인스턴스로 요청을 전달한다.



#### 에지 서버

##### 문제점

일부 마이크로서비스만 시스템 환경 외부에 공개하고, 그 외의 마이크로서비스는 외부에서 접근하지 못하도록 숨기는 게 바람직하다.

##### 해결책

모든 요청이 거치는 시스템 환경에 새 컴포넌트를 추가한다.

##### 해결책의 필요조건

외부로 공개하면 안 되는 내부 서비스는 숨긴다.

서비스를 외부로 공개하되 악의적인 요청으로부터 보호한다. 즉 표준 프로토콜과 OAuth, OIDC, JWT 토큰, API 키 등의 모법 사례를 사용해 신뢰할 수 있는 클라이언트인지 확인한다.



#### 리액티브 마이크로서비스

##### 문제점

블로킹 I/O를 과도하게 사용하면 마이크로서비스 시스템에 오류가 발생하기 쉽다. 어떤 서비스의 지연 시간이 증가하면 가용 스레드가 부족해져 클라이언트가 실패할 수 있다.

##### 해결책

논블로킹 I/O를 사용해 데이터베이스나 다른 마이크로서비스가 처리하길 기다리는 동안 스레드가 할당되지 않게 한다.

##### 해결책의 필요 조건

* 가능하다면 비동기 프로그래밍 모델을 사용한다.
* 의존하는 서비스가 중단되더라도 응답할 수 있도록 탄력성 있게 설계돼야 하며, 중단된 서비스가 재개되면 클라이언트가 서비스를 다시 사용할 수 있어야 한다.



#### 구성 중앙화

##### 문제점

애플리케이션은 여러 환경 변수나 파일에 담긴 구성 정보와 함께 배포되는데, 다수의 마이크로서비스 인스턴스가 배포된 마이크로 서비스 아키텍처 기반의 시스템 환경에선 문제가 조금 있다.

* 실행 중인 모든 카이크로서비스 인스턴스의 구성 정보를 한눈에 보려면 어떻게 해야 하는가?
* 구성을 업데이트하고 관련된 모든 마이크로서비스 인스턴스가 올바르게 업데이트 되게 하려면 어떻게 해야 하는가?

##### 해결책

마이크로서비스 구성 정보를 저장하는 새 컴포넌트를 추가한다.

##### 해결책의 필요 조건

마이크로서비스 집합에 대한 구성 정보를 한 곳에 저장하고 환경별(dev, test, qa, prod) 설정을 지원한다.



#### 로그 분석 중앙화

##### 문제점

보통 로컬 머신에 애플리케이션 로그 이벤트를 기록하는데, 다수의 마이크로 서비스에서는 다음과 같은 문제가 있다.

* 로컬에 로그 파일을 기록하는 상황에서 전체 시스템 환경에서 발생하는 사건을 개괄하려면 어떻게 해야 하는가?
* 문제가 발생한 마이크로서비스 인스턴스를 찾아서 로그 파일에 오류 메시지를 쓰게 하려면 어떻게 해야 하는가?
* 문제가 발생한 로그 메시지를 찾으르면 어떻게 해야 하는가?

##### 해결책

로그를 중앙화해 관리하고 새 컴포넌트를 추가한다.

* 새 마이크로서비스 인스턴스를 감지해 로그 이벤트를 수집
* 로그 이벤트를 해석해 구조적이고 검색 가능한 형식으로 중앙 데이터베이스에 저장
* 로그 이벤트를 조회 및 분석하기 위한 API와 그래픽 도구를 제공



##### 분산 추적

##### 문제점

마이크로서비스 사이에서 흐르는 요청 및 메시지를 추적할 수 있어야 한다.

다음은 장애 시나리오 예다.

* 최종 사용자가 특정 장애에 대한 해결을 요청했을 때 문제를 일으킨 마이크로서비스를 찾고 근본 원인을 밝히려면 어떻게 해야 하는가?
* 특정 엔티티와 관련된 문제를 지원하고자 이와 관련된 모든로그 메시지를 찾고 싶다.

##### 해결책

관련된 모든 요청 및 메시지에 상관 ID를 넣어야 하고, 모든 로그 이벤트에 상관 ID가 있어야 한다. 중앙화된 로깅 서비스에서 상관 ID를 검색하면 관련된 로그 이벤트를 모두 찾을 수 있다.

##### 해결책의 필요 조건



#### 서킷 브레이커

동기 방식으로 상호 통신하는 마이크로서비스 시스템 환경은 연쇄 장애가 발생할 여지가 있다.

##### 해결책

대상 서비스에 문제가 있다는 것을 감지해 새 요청을 보내지 않도록 차단하는 서킷 브레이커를 추가한다.

##### 해결책의 필요 조건

* 서비스에 문제가 감지되면 시간 초과를 무시하고 바로 실패하도록 서킷을 연다.
* 서비스가 정상 동작하는지 확인하고자 주기적으로 요청을 보낸다.



#### 제어 루프

##### 문제점

분산돼 있는 시스템 환경에선 중단되거나 지연된 마이크로서비스 인스턴스를 수동으로 감지하고 대처하는 것이 어렵다.

##### 해결책

상태를 관찰하는 새 컴포넌트를 시스템 환경에 추가한다.



#### 모니터링 및 경고 중앙화

##### 문제점

응답 시간이나 하드웨어 자원 사용량이 지나치게 높은 경우 문제의 근본 원인을 찾는게 어렵다. 마이크로서비스별 하드웨어 자원 사용량을 분석할 수 있어야 한다.

##### 해결책

마이크로서비스 인스턴스가 사용하는 하드웨어 자원 사용량에 대한 메트릭을 수집하는 새 컴포넌트를 시스템 환경에 추가하다.







