# 9장. 마이크로서비스 테스트 1부

## FTGO 테스트 방식
개발을 마치면 QA팀에서 개발자 코드를 넘겨받아 손으로 확인한다.

문제점)
1. 수동테스트는 비효율
2. 테스트가 너무 늦다

테스트가 잘 안되는 이유?
* 문화적인 요인 (테스트는 QA가 하는 일이야. 개발자가 그런데 신경쓸 시간이 어디있어?)

마이크로서비스에서는 반드시 테스트를 자동화 해야 한다.

## 마이크로서비스 아키텍처의 테스트 전략

FTGO 주문서비스를 변경할 일이 생겼다고 합시다.
당연히 고친 코드가 잘 동작하는지 실행해보아야겠죠.
주문 서비스와 이 서비스 디펜던시(DB, 타 서비스)를 모두 실행한 상태에서 API를 호출하거나 화면에서 마우스를 클릭하여 테스트 할 것입니다.

==> 이런 방식은 속도가 느리고 번거로운 수작업이 동반되는 치명적인 단점이 있다.

## 테스트 개요

테스트의 목적은 SUT(System Under Test)의 동작을 확인하는 것이다.
이는 클래스 수준의 작은 단위, 전체 애플리케이션의 큰단위, 여러 클래스나 개별 서비스처럼 중간규모일 수도 있다.

### 자동화 테스트 작성
* JUnit
* 4단계
    1. 설정(setup) - 초기화
    2. 실행(exercise) - 해당 클래스의 메소드 호출
    3. 확인(verify) - 호출결과를 단언(assertion)한다.
    4. 정리(teardown) - 결과 정리. DB 롤백 등

### 목/스텁을 이용한 테스트
service 테스트 시 해당 서비스만 테스트 하는 방법은 테스트 더블(test double)로 대체

테스트더블은 스텁과 목이 있다.

### 테스트 종류
* 성능 테스트 (performance test)
    * 성능을 측정하기 위해 실제 사용될 것과 같은 환경에서 작동
    * 응답속도, 단위 시간당 처리량

* 사용성 테스트 (usability test)
    * 제품이나 서비스를 사용하는데 얼마나 쉽게 즐거운가?
    * 원하는 목적이 제대로 달성, 가능한 편리하게 수행, 전반적인 사용 만족도 측정

* 탐사 테스트 (exploratory test)
    * 사전에 test case가 정의되어 있지 않고 테스터가 상황에 따른 테스트를 진행하는 유형을 말한다. 
    * 탐사 테스트는 'thinking' 활동에 좀 더 집중되어 있다.
    * agile에서 많이 사용한다. 개인적 자유도, 테스터의 책임 중요 

* 인수 테스트
    * 기능적/비기능적 요구사항을 사용자가 직접 테스트하여 개발이 완료되었음을 증명하는 테스트
    * 고객의 입장에서 수행
    
* 접근성 테스트
* 규제 준수 테스트
* UI 테스트
* 부하 테스트
* 시스템 테스트
    * 블랙박스 테스트
    
* 회귀 테스트 (regression test)
    * 기능 추가나 오류 수정으로 인해 새로운 오류가 없는지 확인하는 일종의 반복 테스트이다.

[이 책에서 얘기하는 내용]
* 단위 테스트 (unit test)
* 통합 테스트 (integration test)
* 컴포넌트 테스트 (component test)
* 종단간 테스트 (end-to-end test)

### 테스트 사분면
브라이언 매릭

테스트사분면
![테스트사분면](http://postfiles16.naver.net/20121213_287/infopub_1355356260562YdYz8_PNG/%B1%D7%B8%B2_6-1.png?type=w1)

테스트 피라미드
![테스트 피라미드](https://chrisrichardson.net/i/posts/Test_Pyramid.png)
어떻게 해야 하는가?


#### 비즈니스에 관한 테스트인가?
* 비즈니스 전문가가 이해할 수 있는가?
* 예) 계좌에서 돈을 인출하면 자동적으로 돈이 출금되어야 한다.
* product owner, business analysis

#### 기술에 관한 테스트인가?
* 기술 전문가가 이해할 수 있는가?
* 예) 브라우저는 각기 다른 javascript 사용방식을 사용한다. 제품이 모든 브라우저에서 작동하는가?
* developer, tester

#### 테스트를 하는 목적이 프로그래밍을 지원하기 위함인가?
* 소프트웨어가 무엇을 해야 하는가를 정의하는 것
* 계좌 상세내역을 클릭하면 상세내역 화면이 표시된다.
* 요구사항 명세와 비슷(?)
 
#### 아니면 애플리케이션을 평가하기 위함인가?
* 완성된 프로그램에서 문제를 확인하기 위함
* 버그를 찾기위한 활동
* 예) 로그인 후 다른 사용자의 정보 조회되지 않는가?
* 예) 버튼을 1000번 동시 클릭 시 에러발생
* 예) 부하테스트로 1000번의 api 호출 시 응답속도 느려짐

http://blog.naver.com/PostView.nhn?blogId=infopub&logNo=100173843899

[1사분면]
* 단위 테스트, 컴포넌트 테스트
* 테스트 주도 개발, 애자일 개발 실천법

[2사분면]
* 기능 테스트, 스토리 테스트
* 고객 중심 테스트

[3사분면]
* 탐색적 테스트, 사용성 테스트
* 소프트웨어가 기대에 못미치거나 경쟁력이 떨어지는지 확인 

[4사분면]
* 성능, 부하테스트, 보안테스트, **성 테스트
* 기술 중심 테스트

## 마이크로서비스 테스트
마이크로서비스는 IPC 테스트가 중요하다.
- rest api
- message

서비스간 테스트
* 두 서비스간의 상호작용은 두 서비스 사이의 합의 또는 계약이다.
* 커맨드채널/포맷, 응답 메시지 포맷에 대한 합의
* 종단간 테스트는 실행하기 어렵다.
* 컨슈머 주도 계약 테스트(consumer-driven contract test)를 활용

### 컨슈머 주도 계약 테스트
프로바이더의 API형상이 컨슈머가 기대한 것과 부합하는지 확인하는 것
* 컨슈머가 기대한 HTTP 메소드와 경로인가?
* 컨슈머가 기대한 헤더를 받는가?
* 요청 본문을 받는가?
* 컨슈머가 기대한 상태 코드, 헤더, 본문이 포함된 응답을 반환하는가?

컨슈머 계약 테스트는 프로바이더의 비즈니스 로직을 빠짐없이 체크하는 테스트가 아니다.

### 서비스 테스트: 스프링 클라우드 컨트랙트
각 서비스 계약을 명세하고 client 입장에서 api 연계를 테스트 하여 계약관계가 잘 맞는지 확인

## 서비스 단위 테스트 작성
클래스 기준 테스트

* 단위 테스트 작성: 엔터티
* 단위 테스트 작성: 밸류 객체
* 단위 테스트 작성: 사가
* 단위 테스트 작성: 도메인 서비스
* 단위 테스트 작성: 컨트롤러
* 단위 테스트 작성: 이벤트/메시지 핸들러

# 마이크로서비스 테스트 2부

## 통합 테스트 작성
인프라 서비스, 타 애플리케이션 서비스와 적절히 연동되는지 확인하는 테스트 

1. 각 서비스의 어댑터를 테스트
2. 계약을 활용하여 테스트

* 영속화
* REST 요청/응답형 상호 작용
* 발행/구독 스타일 상호 작용
* 비동기 요청/응답 상호 작용

## 컴포넌트 테스트 개발
서비스를 따로 분리하여 서비스 자체만 테스트 (디펜던시는 모킹)

## 종단간 테스트 작성


---
### [Q&A]

Q) 377 TDD를 attic에 적용 한다면, 어떻게 적용해야 할까요?


---
Q) 378 1~4에 대한 attic/eer기준 어떠한 테스트를 예로 들 수 있을까요?

* 기능테스트 - user story 기반
* 인수테스트 - sprint
* 탐사테스트 - 통합테스트 내 포함
* 가용성테스트 - if needed
* 단위테스트 - junit
* 통합테스트 - junit
* 컴포넌트테스트 - N/A
* 비기능 인수테스트 - if needed
* 성능테스트 - sprint
* 보안테스트 - if needed

---
Q) 385 9-8 그림 설명해 주세요.

A)
1. [api gateway 팀] service에서 groovy로 contract 명세를 작성하여 전달
2. [service 팀] test 코드 작성
3. [service 팀] build 및 deploy
4. [api gateway 팀] client api 테스트

---
Q) 409 "9.2.5 단위 테스트 작성:컨트롤러(p396)" 과 비슷한 테스트를 다른 방식으로 기술 된것으로 보입니다. 어떠한 차이가 있을까요?

A) 단위 테스트의 컨트롤러 테스트는 컨트롤러 자체의 in/out이 명세에 맞게 잘 동작하는지 테스트를 하는 것입니다. 
controller 내부의 service, repository 등 다른 요소는 mock으로 대체

통합테스트의 rest 테스트는 다른 서비스와의 spec이 잘 일치하는지 확인하기 위한 용도로 사용됩니다.
이를 위해서 컨슈머 주도 계약 테스트를 활용

---
Q) 소스 커버리지에 대한 내용은 없습니다. MSA 아키텍쳐에서는 커버리지가 중요하지 않을걸까요? 혹시 중요하다면 테스트 방식은 어떤것들이 있을까요?

소스 커버리지는 microservice와 관련없이 software 품질에 중요한 요소이다. 
단, 테스트 케이스 작성이 쉽고 잘 깨지지 않는 구성을 가지는 것이 더 중요하다.
소프트웨어 특성에 따라 커버리지 기준은 달라져야 하고 특정 수준을 맞춰야 한다.

controller, service, repository, domain, event 등 모든 모듈에 test가 필요한지? 아님 특정부분만 할지..
범위가 너무 크면 작성 시간 및 유지보수에 비용이 많이 발생하니 어느 정도 수준을 유지 하는것이 좋을듯 하다.
 
---
Q) 378 테스트 사분면에 따라 각각의 테스트의 role은 어떻게 되나요? ex) 기능/인수 테스트는 개발자가 한다.

A) role은 비즈니스 관련 내용은 도메인전문가, 현업이 진행
기술관련 된 내용은 개발자, 테스터가 진행

---
Q) 387 완전 자동화가 가장 이상적이지만, 일부 단계는 수작업으로 한다고 했는데, 어떤 작업들이 수작업으로 이루어지나요?

A)


---
Q) 380 attic 에서 IPC 테스트는 어떻게 하고 있나요? 컨슈머 주도 계약 테스트를 사용하나요?

A) 스프링 contract test를 이용하여 테스트는 진행하지 않음.
garade (test)
rest controller test
service test

---
Q) 388 on-premise 프로덕트 배포 파이프라인에서 CI/CD 에 의해 변경 발생하면 배포가 발생할텐데 배포 버전 관리는 어떻게 하는 것이 좋을까요?


---
Q) 392 VO 단위 테스트가 내용에는 독립 단위 테스트인데 9-11 그림에서는 공동 단위 테스트로 되어 있습니다. 어떤게 맞을까요?

* 독립 단위 테스트: 클래스 디펜던시를 목 객체로 나타내고 클래스를 따로 테스트 합니다.
* 공동 단위 테스트: 클래스와 디펜던시를 테스트합니다.

엔터티와 밸류 객체는 공동 단위 테스트를 사용한다고 함.
여기서 말하는 것은 Money 클래스는 외부 *의존성*이 전혀 없기 때문에 독립 단위 테스트라고 말하는 것 같음

의존성
1. 연관관계
2. 의존관계
3. 상속관계
4. 실체화 관계

https://velog.io/@codemcd/%EC%9A%B0%EC%95%84%ED%95%9C%ED%85%8C%ED%81%AC%EC%84%B8%EB%AF%B8%EB%82%98-%EC%9A%B0%EC%95%84%ED%95%9C%EA%B0%9D%EC%B2%B4%EC%A7%80%ED%96%A5-%EC%9D%98%EC%A1%B4%EC%84%B1%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%B4-%EC%84%A4%EA%B3%84-%EC%A7%84%ED%99%94%EC%8B%9C%ED%82%A4%EA%B8%B0-By-%EC%9A%B0%EC%95%84%ED%95%9C%ED%98%95%EC%A0%9C%EB%93%A4-%EA%B0%9C%EB%B0%9C%EC%8B%A4%EC%9E%A5-%EC%A1%B0%EC%98%81%ED%98%B8%EB%8B%98-vkk5brh7by


---
Q) 426 수동변환 작업을 없앤다는게 무슨말인가요?

사용자 테스트 케이스 작성 후 코드로 변환하는 작업을 의미(?)
fitness test






